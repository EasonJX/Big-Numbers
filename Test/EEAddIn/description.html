<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/b79636be-b088-48b5-8a8d-c21645d26d2fCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Writing debugger type visualizers for C++ using .natvis files and MS EEAddin DLL</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Writing debugger type visualizers for C++ using .natvis files and MS EEAddin DLL</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Visual Studio 2012, visualization framework (natvis), EEAddIn DLL
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Debug, Debugging, Debugger, Debugger Extensibility
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop, Data, Windows RT
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">5/17/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/Writing-debugger-type-ff6a2fa8">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Introduction</h1>
<p><em>Visual Studio 2012 finishes using autoexp.dat while debuging and visualising data types. As I know
<a href="http://msdn.microsoft.com/en-us/library/vstudio/jj620914.aspx">visualization framework (natvis)</a> was allready in VS2010, but not completely implemented.
</em><em>For a sample regarding visualization framework (natvis) look <a href="http://code.msdn.microsoft.com/Writing-type-visualizers-2eae77a2">
here</a>.</em></p>
<p><em>In VS2010 and earlier with autoexp.dat it was possible to use external dll file for visualising special types like COledateTime or custom types. This is ex</em>plained
<em><a href="http://msdn.microsoft.com/en-us/library/8fwk67y3%28v=vs.71%29.aspx">here</a></em>.</p>
<p><em>With .natvis files there are better ways to display special types but there are still needs for using an external visualizer dll file, f.e. for date/time types.</em></p>
<h1><span>Building the Sample</span></h1>
<p><em>Installed Visual Studio 2012 is required. Just download the sample, extract it and then open solution, all neccessary files are included. Plus the registry file for displaying the natvis diagnostics, see chapter below.<br>
</em></p>
<h1><span style="font-size:20px; font-weight:bold">Description</span></h1>
<h2>Natvis diagnostics</h2>
<p style="text-align:justify">Natvis diagnostics is a very important tool that helps troubleshooting issues when writing new type visualizers. When the debugger encounters errors in a visualizer entry (e.g. xml schema errors, expression fails to parse), it
 will simply ignore it and display the type in its raw form or pick another suitable visualizer. To understand why a certain visualizer entry is ignored and to see what the underlying errors are, you can turn on visualization diagnostics which is controlled
 by the following registry value:</p>
<p style="text-align:justify">[HKEY_CURRENT_USER\Software\Microsoft\VisualStudio\11.0_Config\Debugger]</p>
<p style="text-align:justify">&quot;EnableNatvisDiagnostics&quot;=dword:00000001</p>
<p style="text-align:justify">When turned on, you will see diagnostic status messages (e.g. when a natvis file is parsed, an expression is successfully evaluated) and error messages (e.g. file parse errors, expression parse errors) in the output window in Visual
 Studio. The sample contains an registry file to enable it.</p>
<h2 style="text-align:justify">How does it work</h2>
<p style="text-align:justify">Every time the debuger starts it parses the available natvis files and then it looks how to display each data type. In this case the natvis file commits the type memory pointer to the EEAddIn DLL, whish creates an Object from the
 pointer and evaluate it. On how to build or extend the EEAddIn DLL look on the link to the EEAddIn Sample.</p>
<h2>Syntax Reference</h2>
<p>The sample contains visualizer for folowing types: _SYSTEMTIME, _FILETIME, ATL::COleDateTime, ATL::COleDateTimeSpan. I show here only for COleDateTime as they are similar on how to use.</p>
<p>Folowing entry advice the visualization framework to use an external DLL</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>XML</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">xml</span>
<pre class="hidden">  &lt;Type Name=&quot;ATL::COleDateTimeSpan&quot;&gt;
    &lt;DisplayString LegacyAddin=&quot;NatvisAddIn.dll&quot; Export=&quot;AddIn_COleDateTimeSpan&quot;&gt;&lt;/DisplayString&gt;
  &lt;/Type&gt;</pre>
<div class="preview">
<pre class="xml">&nbsp;&nbsp;<span class="xml__tag_start">&lt;Type</span>&nbsp;<span class="xml__attr_name">Name</span>=<span class="xml__attr_value">&quot;ATL::COleDateTimeSpan&quot;</span><span class="xml__tag_start">&gt;&nbsp;
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="xml__tag_start">&lt;DisplayString</span>&nbsp;<span class="xml__attr_name">LegacyAddin</span>=<span class="xml__attr_value">&quot;NatvisAddIn.dll&quot;</span>&nbsp;<span class="xml__attr_name">Export</span>=<span class="xml__attr_value">&quot;AddIn_COleDateTimeSpan&quot;</span><span class="xml__tag_start">&gt;</span><span class="xml__tag_end">&lt;/DisplayString&gt;</span>&nbsp;
&nbsp;&nbsp;<span class="xml__tag_end">&lt;/Type&gt;</span></pre>
</div>
</div>
</div>
<p>Folowing function visualize the Object in the EEAddIn DLL and gives it back to the visualizer</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C&#43;&#43;</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">cplusplus</span>
<pre class="hidden">ADDIN_API HRESULT WINAPI AddIn_COleDateTime( DWORD dwAddress, DEBUGHELPER *pHelper, int nBase, BOOL bUniStrings, char *pResult, size_t maxResult, DWORD /*reserved*/ )
{
	COleDateTime datetime;
	DWORD nGot;

	// read system time from debuggee memory space
	HRESULT hr = pHelper-&gt;ReadDebuggeeMemoryEx(pHelper, pHelper-&gt;GetRealAddress(pHelper), sizeof(datetime), &amp;datetime, &amp;nGot);
	if (hr != S_OK || nGot != sizeof(datetime))
		sprintf_s(pResult, maxResult, &quot;Error while formating variable!&quot;);
	else 
		sprintf_s(pResult, maxResult, datetime.GetStatus() == COleDateTime::valid ? datetime.Format() : &quot;Invalid DateTime object.&quot;);

	return S_OK;
}
</pre>
<div class="preview">
<pre class="cplusplus">ADDIN_API&nbsp;<span class="cpp__datatype">HRESULT</span>&nbsp;WINAPI&nbsp;AddIn_COleDateTime(&nbsp;<span class="cpp__datatype">DWORD</span>&nbsp;dwAddress,&nbsp;DEBUGHELPER&nbsp;*pHelper,&nbsp;<span class="cpp__datatype">int</span>&nbsp;nBase,&nbsp;<span class="cpp__datatype">BOOL</span>&nbsp;bUniStrings,&nbsp;<span class="cpp__datatype">char</span>&nbsp;*pResult,&nbsp;<span class="cpp__datatype">size_t</span>&nbsp;maxResult,&nbsp;<span class="cpp__datatype">DWORD</span>&nbsp;<span class="cpp__mlcom">/*reserved*/</span>&nbsp;)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;COleDateTime&nbsp;datetime;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cpp__datatype">DWORD</span>&nbsp;nGot;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cpp__com">//&nbsp;read&nbsp;system&nbsp;time&nbsp;from&nbsp;debuggee&nbsp;memory&nbsp;space</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cpp__datatype">HRESULT</span>&nbsp;hr&nbsp;=&nbsp;pHelper-&gt;ReadDebuggeeMemoryEx(pHelper,&nbsp;pHelper-&gt;GetRealAddress(pHelper),&nbsp;<span class="cpp__keyword">sizeof</span>(datetime),&nbsp;&amp;datetime,&nbsp;&amp;nGot);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cpp__keyword">if</span>&nbsp;(hr&nbsp;!=&nbsp;S_OK&nbsp;||&nbsp;nGot&nbsp;!=&nbsp;<span class="cpp__keyword">sizeof</span>(datetime))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf_s(pResult,&nbsp;maxResult,&nbsp;<span class="cpp__string">&quot;Error&nbsp;while&nbsp;formating&nbsp;variable!&quot;</span>);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cpp__keyword">else</span>&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf_s(pResult,&nbsp;maxResult,&nbsp;datetime.GetStatus()&nbsp;==&nbsp;COleDateTime::valid&nbsp;?&nbsp;datetime.Format()&nbsp;:&nbsp;<span class="cpp__string">&quot;Invalid&nbsp;DateTime&nbsp;object.&quot;</span>);&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cpp__keyword">return</span>&nbsp;S_OK;&nbsp;
}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;Folowing line tests the visualizer</div>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C&#43;&#43;</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">cplusplus</span>
<pre class="hidden">{
	COleDateTime odt = COleDateTime::GetCurrentTime();
	CString strOut = odt.Format();
	cout &lt;&lt; &quot;Checkout String and DateTime&quot;; //Breakpoint here and then hover mouse on odt above :)
}
</pre>
<div class="preview">
<pre class="cplusplus">{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;COleDateTime&nbsp;odt&nbsp;=&nbsp;COleDateTime::GetCurrentTime();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;CString&nbsp;strOut&nbsp;=&nbsp;odt.Format();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;<span class="cpp__string">&quot;Checkout&nbsp;String&nbsp;and&nbsp;DateTime&quot;</span>;&nbsp;<span class="cpp__com">//Breakpoint&nbsp;here&nbsp;and&nbsp;then&nbsp;hover&nbsp;mouse&nbsp;on&nbsp;odt&nbsp;above&nbsp;:)</span>&nbsp;
}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p>The output in the debuger without visualizer, absolutely no idea what time ist is, but it is valid!</p>
<p>&nbsp;</p>
<p style="padding-left:30px"><img id="82224" src="description/without visualizer.jpg" alt="" width="490" height="84"></p>
<p>&nbsp;</p>
<p>The output in the debuger with visulaziter, much better!</p>
<p style="padding-left:30px"><img id="82225" src="description/with visualizer.jpg" alt="" width="427" height="83"></p>
<p>&nbsp;</p>
<p>The output in Autos, Locals and Watch is also the good one!</p>
<p style="padding-left:30px"><img id="82226" src="description/with visualizer watch.jpg" alt="" width="677" height="136"></p>
<p>I hope this helps you, as it did for me, feel free to use it and extend it how you want. I hope microsoft will never remove this feature as I have absolutely no idea how to display such special types.</p>
<p>Big thanks goes to the user <a href="http://stackoverflow.com/users/317797/bsalita">
BSalita</a> for his <a href="http://stackoverflow.com/a/11545420/2389933">answer</a> that helps me a lot!</p>
<h1><span>Source Code Projects</span></h1>
<ul>
<li><em>NatvisAddIn - This builds the EEAddIn DLL and copy it to the VS2012 %USERFILES% Visualizer directory. The included .natvis file will also be copied with cutom build step.</em>
</li><li><em><em><em>TestNatvisAddIn&nbsp;- This is a Test-Project to test the AddIn DLL while debuging.<br>
</em></em></em></li></ul>
<div class="mcePaste" id="_mcePaste" style="left:-10000px; top:0px; width:1px; height:1px; overflow:hidden">
<h2 class="projectSummary">visualization framework (natvis)visualization framework (natvis)</h2>
</div>

</div>


    </div>
</body>
</html>
